<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="egovframework.example.community.service.impl.CommunityMapper">



	<select id="selectCommunityList"
        parameterType="egovframework.example.common.Criteria"
        resultType="egovframework.example.community.service.CommunityVO">
  
  SELECT
    COMMUNITY.UUID AS uuid,
    COMMUNITY.USER_ID AS userId,
    USERS.NICKNAME AS userNickname,
    COMMUNITY.COMMUNITY_TITLE AS communityTitle,
    COMMUNITY.COMMUNITY_CONTENT AS communityContent,
    COMMUNITY.COMMUNITY_LIKE_COUNT AS communityLikeCount,
    COMMUNITY.COUNT AS communityCount,
    COMMUNITY.COMMUNITY_IMAGE AS communityImage,
    COMMUNITY.COMMUNITY_CREATED_AT AS communityCreatedAt,
    COMMUNITY.CONTENT_TYPE AS contentType,
    COMMUNITY.COMMUNITY_CATEGORY_ID AS communityCategoryId,
    
    (SELECT COUNT(*) 
     FROM COMMENTS 
     WHERE COMMENTS.UUID = COMMUNITY.UUID 
       AND COMMENTS.TARGET_TYPE = 'community') AS commentCount
  
  FROM COMMUNITY
  JOIN USERS ON COMMUNITY.USER_ID = USERS.USER_ID
  
  <where>
    <if test="searchKeyword != null and searchKeyword != ''">
      COMMUNITY.COMMUNITY_TITLE LIKE '%' || #{searchKeyword} || '%'
    </if>
  </where>
  
  ORDER BY COMMUNITY.COMMUNITY_CREATED_AT DESC
  OFFSET #{firstIndex} ROWS
  FETCH NEXT #{pageUnit} ROWS ONLY

</select>

   <select id="selectCommunityListTotCnt"
           parameterType="egovframework.example.common.Criteria"
           resultType="int">
	   SELECT COUNT(*) FROM COMMUNITY
	   <where>
  <if test="searchKeyword != null and searchKeyword != ''">
    COMMUNITY_TITLE LIKE '%' || #{searchKeyword} || '%'
  </if>
</where>
   </select>

   <insert id="insert" parameterType="CommunityVO">
       INSERT INTO COMMUNITY (
  UUID, USER_ID, COMMUNITY_TITLE, COMMUNITY_CONTENT, COMMUNITY_LIKE_COUNT,
  COUNT, COMMUNITY_IMAGE, COMMUNITY_CREATED_AT, CONTENT_TYPE,
   
  COMMUNITY_CATEGORY_ID) VALUES 
  
   (#{uuid}, #{userId}, #{communityTitle}, #{communityContent},
   #{communityLikeCount},#{communityCount}, #{communityImage}, 
   TO_DATE(#{communityCreatedAt}, 'YY-MM-DD HH24:MI'), #{contentType}, #{communityCategoryId})
   </insert>

<update id="update" parameterType="egovframework.example.community.service.CommunityVO">
    UPDATE community
    SET community_title = #{communityTitle},
        community_content = #{communityContent},
        community_image = #{communityImage}
    WHERE uuid = #{uuid}
</update>

<update id="increaseViewCount" parameterType="String">
    UPDATE COMMUNITY
    SET COUNT = COUNT + 1
    WHERE UUID = #{uuid}
</update>

<update id="increaseLikeCount" parameterType="String">
    UPDATE COMMUNITY
    SET COMMUNITY_LIKE_COUNT = COMMUNITY_LIKE_COUNT + 1
    WHERE UUID = #{uuid}
</update>


   <delete id="delete" parameterType="CommunityVO">
       DELETE FROM COMMUNITY
       WHERE UUID=#{uuid}
   </delete>
   
   <select id="selectCommunity"
        parameterType="String"
        resultType="egovframework.example.community.service.CommunityVO">
    SELECT UUID AS uuid,
           USER_ID AS userId,
           COMMUNITY_CATEGORY_ID AS communityCategoryId,
           COMMUNITY_TITLE AS communityTitle,
           COMMUNITY_CREATED_AT AS communityCreatedAt,
           COMMUNITY_LIKE_COUNT AS communityLikeCount,
           COMMUNITY_CONTENT AS communityContent,
           COUNT AS communityCount,
           COMMUNITY_IMAGE AS communityImage,
           COMMUNITY_URL AS communityUrl
    FROM COMMUNITY
    WHERE UUID = #{uuid}
</select>

<select id="getLikeCount" parameterType="String" resultType="int">
  SELECT community_like_count
  FROM community
  WHERE uuid = #{uuid}
</select>
 


</mapper>